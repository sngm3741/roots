name: Pages - makotoclub-admin

on:
  push:
    branches: [main]
    paths:
      - "apps/makotoclub/admin/**"
      - ".github/workflows/pages-makotoclub-admin.yml"
  pull_request:
    paths:
      - "apps/makotoclub/admin/**"
      - ".github/workflows/pages-makotoclub-admin.yml"

concurrency:
  group: pages-makotoclub-admin-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  verify:
    name: verify
    runs-on: ubuntu-latest
    outputs:
      admin_present: ${{ steps.check_admin.outputs.exists }}
    defaults:
      run:
        working-directory: apps/makotoclub/admin
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check admin directory exists
        id: check_admin
        run: |
          if [ -d "apps/makotoclub/admin" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "apps/makotoclub/admin not found; skipping admin workflow."
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/makotoclub/admin/package-lock.json
        if: steps.check_admin.outputs.exists == 'true'

      - name: Install
        run: npm ci
        if: steps.check_admin.outputs.exists == 'true'

      # ここはプロジェクトの実態に合わせて lint/test/build を調整してください
      - name: Build
        run: npm run build
        if: steps.check_admin.outputs.exists == 'true'

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: makotoclub-admin-build
          path: apps/makotoclub/admin/dist
          if-no-files-found: error
          retention-days: 7
        if: steps.check_admin.outputs.exists == 'true'

  deploy_production:
    name: deploy_production
    needs: verify
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.verify.outputs.admin_present == 'true'
    defaults:
      run:
        working-directory: apps/makotoclub/admin
    steps:
      - name: Checkout (full history for commit message)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/makotoclub/admin/package-lock.json

      - name: Install Wrangler
        run: npm i -g wrangler@3

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: makotoclub-admin-build
          path: apps/makotoclub/admin/dist

      # ✅ 追加: Git を UTF-8 前提にする
      - name: Ensure git uses UTF-8
        run: |
          git config --global i18n.commitEncoding utf-8
          git config --global i18n.logOutputEncoding utf-8

      # ✅ 追加: commit message を検査し、ダメならローカル空コミットで HEAD を差し替える
      - name: Sanitize commit message (create empty commit if necessary)
        run: |
          set -euo pipefail

          MSG="$(git log -1 --pretty=%B || true)"

          # iconv で UTF-8 として解釈できるか検査
          if ! printf '%s' "$MSG" | iconv -f utf-8 -t utf-8 >/dev/null 2>&1; then
            echo "Invalid UTF-8 commit message detected. Creating a sanitized empty commit on runner HEAD..."
            git -c user.name='github-actions[bot]' \
                -c user.email='41898282+github-actions[bot]@users.noreply.github.com' \
                commit --allow-empty -m "CI: Deploy from GitHub Actions"
          else
            echo "Commit message is valid UTF-8. No action needed."
          fi

      - name: Deploy to Cloudflare Pages (production)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          wrangler pages deploy dist --project-name makotoclub-admin

  deploy_preview:
    name: deploy_preview
    needs: verify
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && needs.verify.outputs.admin_present == 'true'
    defaults:
      run:
        working-directory: apps/makotoclub/admin
    steps:
      - name: Checkout (full history for commit message)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/makotoclub/admin/package-lock.json

      - name: Install Wrangler
        run: npm i -g wrangler@3

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: makotoclub-admin-build
          path: apps/makotoclub/admin/dist

      # ✅ 追加: Git を UTF-8 前提にする
      - name: Ensure git uses UTF-8
        run: |
          git config --global i18n.commitEncoding utf-8
          git config --global i18n.logOutputEncoding utf-8

      # ✅ 追加: commit message を検査し、ダメならローカル空コミットで HEAD を差し替える
      - name: Sanitize commit message (create empty commit if necessary)
        run: |
          set -euo pipefail

          MSG="$(git log -1 --pretty=%B || true)"

          if ! printf '%s' "$MSG" | iconv -f utf-8 -t utf-8 >/dev/null 2>&1; then
            echo "Invalid UTF-8 commit message detected. Creating a sanitized empty commit on runner HEAD..."
            git -c user.name='github-actions[bot]' \
                -c user.email='41898282+github-actions[bot]@users.noreply.github.com' \
                commit --allow-empty -m "CI: Deploy from GitHub Actions"
          else
            echo "Commit message is valid UTF-8. No action needed."
          fi

      - name: Deploy to Cloudflare Pages (preview)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # PR ではブランチ名/PR番号をメタにしたい場合は --branch を付けてもOK
          wrangler pages deploy dist --project-name makotoclub-admin
